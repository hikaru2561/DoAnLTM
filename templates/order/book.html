<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>S·ªï l·ªánh</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #1e1f26;
        color: #f5f5f5;
        padding: 20px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        background-color: #2a2d3e;
        margin-top: 20px;
      }

      th,
      td {
        padding: 12px;
        border: 1px solid #444;
        text-align: center;
      }

      th {
        background-color: #3a3f5a;
      }

      button {
        padding: 6px 12px;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      button:hover {
        background-color: #45a049;
      }

      .delete-btn {
        background-color: #f44336;
      }

      .delete-btn:hover {
        background-color: #e53935;
      }

      #editModal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.6);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }

      #editModal .modal-content {
        background: #2a2d3e;
        padding: 24px 30px;
        border-radius: 12px;
        width: 400px;
        color: white;
        position: relative;
      }

      #editModal input,
      #editModal select {
        width: 100%;
        padding: 8px;
        margin: 6px 0;
        border-radius: 4px;
        border: none;
      }
    </style>
  </head>

  <body>
    <h2>üìò S·ªï l·ªánh c·ªßa b·∫°n</h2>

    <table id="orderTable">
      <thead>
        <tr>
          <th>M√£ c·ªï phi·∫øu</th>
          <th>S·ªë l∆∞·ª£ng</th>
          <th>Gi√°</th>
          <th>Lo·∫°i l·ªánh</th>
          <th>Th·ªùi ƒëi·ªÉm</th>
          <th>H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div id="editModal">
      <div class="modal-content">
        <h3>‚úèÔ∏è Ch·ªânh s·ª≠a L·ªánh</h3>
        <form id="editOrderForm">
          <input type="hidden" id="edit_order_id" />
          <label>Lo·∫°i l·ªánh:</label>
          <select id="edit_loai_lenh">
            <option value="Mua">Mua</option>
            <option value="B√°n">B√°n</option>
          </select>

          <label>M√£ c·ªï phi·∫øu:</label>
          <input type="text" id="edit_stock_id" required />

          <label>Gi√° l·ªánh:</label>
          <input type="number" id="edit_gia_lenh" step="0.01" required />

          <label>S·ªë l∆∞·ª£ng:</label>
          <input type="number" id="edit_so_luong" required />

          <button type="submit">C·∫≠p nh·∫≠t</button>
          <button type="button" onclick="closeModal()" style="background: gray">
            H·ªßy
          </button>
          <pre id="edit_result">Ch∆∞a c√≥ k·∫øt qu·∫£</pre>
        </form>
      </div>
    </div>

    <script>
      async function loadOrderBook() {
        try {
          const res = await fetch("/order/book", { credentials: "include" });
          const data = await res.json();

          if (!res.ok) {
            alert(data.message || "L·ªói khi t·∫£i s·ªï l·ªánh");
            return;
          }

          renderOrderTable(data.orders);
        } catch (err) {
          console.error("L·ªói k·∫øt n·ªëi:", err);
        }
      }

      function renderOrderTable(orders) {
        const tbody = document.querySelector("#orderTable tbody");
        tbody.innerHTML = "";

        orders.forEach((order) => {
          const row = document.createElement("tr");

          row.innerHTML = `
            <td>${order.symbol_id}</td>
            <td>${order.so_luong}</td>
            <td>${order.gia}</td>
            <td>${order.loai_lenh}</td>
            <td>${order.thoi_diem}</td>
            <td>
              <button onclick='openEditModal(${JSON.stringify(
                order
              )})'>S·ª≠a</button>
              <button class="delete-btn" onclick='deleteOrder(${
                order.ID
              })'>H·ªßy</button>
            </td>
          `;

          tbody.appendChild(row);
        });
      }

      function openEditModal(order) {
        document.getElementById("edit_order_id").value = order.ID;
        document.getElementById("edit_loai_lenh").value = order.loai_lenh;
        document.getElementById("edit_stock_id").value = order.symbol_id;
        document.getElementById("edit_gia_lenh").value = order.gia;
        document.getElementById("edit_so_luong").value = order.so_luong;
        document.getElementById("editModal").style.display = "flex";
      }

      function closeModal() {
        document.getElementById("editModal").style.display = "none";
      }

      document
        .getElementById("editOrderForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const id = document.getElementById("edit_order_id").value;

          const payload = {
            loai_lenh: document.getElementById("edit_loai_lenh").value,
            stock_id: document.getElementById("edit_stock_id").value,
            gia_lenh: parseFloat(
              document.getElementById("edit_gia_lenh").value
            ),
            so_luong: parseInt(document.getElementById("edit_so_luong").value),
          };

          try {
            const res = await fetch(`/order/update/${id}`, {
              method: "PUT",
              credentials: "include",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });

            const data = await res.json();
            document.getElementById("edit_result").textContent = data.message;

            if (res.ok) {
              closeModal();
              loadOrderBook();
            }
          } catch (err) {
            document.getElementById("edit_result").textContent =
              "‚ùå L·ªói c·∫≠p nh·∫≠t: " + err.message;
          }
        });

      async function deleteOrder(orderId) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy l·ªánh?")) return;

        try {
          const res = await fetch(`/order/cancel/${orderId}`, {
            method: "DELETE",
            credentials: "include",
          });

          const data = await res.json();
          alert(data.message || "‚úÖ ƒê√£ h·ªßy l·ªánh");
          loadOrderBook();
        } catch (err) {
          alert("‚ùå L·ªói khi h·ªßy l·ªánh: " + err.message);
        }
      }

      loadOrderBook();
    </script>
  </body>
</html>
