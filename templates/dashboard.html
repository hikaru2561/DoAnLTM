<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>WebSocket Table</title>
  <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/detailformstock.css') }}">
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
    /* Style chung gi·ªØ nguy√™n */
    table {
      border-collapse: collapse;
      width: 100%;
    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 4px 8px;
      text-align: center;
    }

    th {
      background-color: #f0f0f0;
    }
  </style>
</head>

<body>
  <div class="header-bar">
    <div class="logo-section">
      <div class="logo-icon">QQT</div>
    </div>

    <div class="right-section">
      <!-- ƒê·ªìng h·ªì -->
      <span class="clock" id="clock">--:--:--</span>

      <div class="icon-wrapper" title="Th√¥ng b√°o">
        <i data-feather="bell"></i>
      </div>

      <!-- Bi·ªÉu t∆∞·ª£ng ƒë·ªïi n·ªÅn (m·∫∑t tr·ªùi) -->
      <div class="icon-wrapper" title="M√†u n·ªÅn">
        <i data-feather="sun"></i>
      </div>

      <!-- Ng√¥n ng·ªØ -->
      <div class="lang-dropdown">
        <button class="icon-wrapper lang-btn" title="Ng√¥n ng·ªØ">
          <img src="https://flagcdn.com/h40/vn.png" class="flag-icon-round" alt="VN">
        </button>
        <div class="lang-menu">
          <div class="lang-item"><img src="https://flagcdn.com/h40/us.png" alt="EN"> English</div>
          <!-- <div class="lang-item"><img src="https://flagcdn.com/h40/vn.png" alt="VN"> Ti·∫øng Vi·ªát</div> -->
          <div class="lang-item"><img src="https://flagcdn.com/h40/cn.png" alt="CN"> ‰∏≠Êñá (Chinese)</div>
        </div>
      </div>
      <!-- C√°c n√∫t t√†i kho·∫£n -->
      <button id="openAccountBtn" class="open-account" onclick="openRegisterModal()">M·ªü t√†i kho·∫£n</button>
      <button id="loginBtn" onclick="openLoginModal()">ƒêƒÉng nh·∫≠p</button>

      <!-- Hi·ªÉn th·ªã sau khi ƒëƒÉng nh·∫≠p -->
      <div id="userInfo" style="display: none; margin-left: 10px; font-weight: bold;">
        Xin ch√†o, <span id="usernameDisplay"></span>
        <button id="logoutBtn" onclick="logout()" style="margin-left: 10px; padding: 5px 10px;">ƒêƒÉng xu·∫•t</button>
      </div>
    </div>
  </div>
  <!-- üî∫ Submenu theo y√™u c·∫ßu -->
  <div class="submenu">
    <ul class="submenu-list">
      <li class="nav-item">
        <a href="#" class="nav-link">B·∫£ng gi√°</a>
      </li>
      <li class="nav-item dropdown">
        <a href="#" class="nav-link">
          Giao d·ªãch c∆° s·ªü
          <i class="arrow-down" data-feather="chevron-down"></i>
        </a>
        <div class="dropdown-menu mega-menu">
          <div class="dropdown-column">
            <div class="dropdown-item">
              <i data-feather="arrow-right-circle"></i>
              <div>
                <strong>ƒê·∫∑t l·ªánh</strong>
                <span>ƒê·∫∑t l·ªánh mua b√°n ch·ª©ng kho√°n tr√™n th·ªã tr∆∞·ªùng c∆° s·ªü</span>
              </div>
            </div>
            <div class="dropdown-item">
              <i data-feather="edit-2"></i>
              <div>
                <strong>ƒê·∫∑t l·ªánh ƒëi·ªÅu ki·ªán</strong>
                <span>Thi·∫øt l·∫≠p ƒëi·ªÅu ki·ªán k√≠ch ho·∫°t l·ªánh t·ª± ƒë·ªông</span>
              </div>
            </div>
            <div class="dropdown-item">
              <i data-feather="list"></i>
              <div>
                <strong>Danh m·ª•c</strong>
                <span>Theo d√µi danh m·ª•c c·ªï phi·∫øu ƒëang ƒë·∫ßu t∆∞</span>
              </div>
            </div>
            <div class="dropdown-item">
              <i data-feather="book"></i>
              <div>
                <strong>S·ªï l·ªánh</strong>
                <span>Theo d√µi tr·∫°ng th√°i l·ªánh trong phi√™n</span>
              </div>
            </div>
          </div>
          <div class="dropdown-column">
            <div class="dropdown-item">
              <i data-feather="shuffle"></i>
              <div>
                <strong>Chuy·ªÉn ch·ª©ng kho√°n</strong>
                <span>Chuy·ªÉn ch·ª©ng kho√°n gi·ªØa c√°c ti·ªÉu kho·∫£n</span>
              </div>
            </div>
            <div class="dropdown-item">
              <i data-feather="plus-square"></i>
              <div>
                <strong>Th√¥ng tin quy·ªÅn</strong>
                <span>Tra c·ª©u quy·ªÅn mua & ƒëƒÉng k√Ω</span>
              </div>
            </div>
            <div class="dropdown-item">
              <i data-feather="shield"></i>
              <div>
                <strong>IPO Ch·ª©ng quy·ªÅn</strong>
                <span>ƒêƒÉng k√Ω IPO ch·ª©ng quy·ªÅn t·∫°i SSI</span>
              </div>
            </div>
            <div class="dropdown-item">
              <i data-feather="clock"></i>
              <div>
                <strong>L·ªãch s·ª≠ l·ªánh</strong>
                <span>Xem th√¥ng tin c√°c l·ªánh ƒë√£ ƒë·∫∑t</span>
              </div>
            </div>
          </div>
        </div>
      </li>
      <li class="nav-item dropdown">
        <a href="#" class="nav-link">
          Qu·∫£n l√Ω t√†i s·∫£n
          <i class="arrow-down" data-feather="chevron-down"></i>
        </a>
        <div class="dropdown-menu mega-menu one-column">
          <div class="dropdown-column">
            <div class="dropdown-item">
              <i data-feather="star"></i>
              <div>
                <strong>T√†i s·∫£n & Hi·ªáu su·∫•t ƒë·∫ßu t∆∞</strong>
                <span class="desc">Th√¥ng tin to√†n c·∫£nh v·ªÅ t√†i s·∫£n v√† hi·ªáu qu·∫£ ƒë·∫ßu t∆∞ theo th·ªùi gian</span>
              </div>
            </div>
            <div class="dropdown-item">
              <i data-feather="check-circle"></i>
              <div>
                <strong>L√£i/l·ªó theo giao d·ªãch</strong>
                <span class="desc">Theo d√µi l·ªãch s·ª≠ l√£i/l·ªó ƒë√£ th·ª±c hi·ªán theo t·ª´ng m√£ c·ªï phi·∫øu</span>
              </div>
            </div>
          </div>
        </div>
      </li>
      <li class="nav-item dropdown">
        <a href="#" class="nav-link">
          Giao d·ªãch ti·ªÅn
          <i class="arrow-down" data-feather="chevron-down"></i>
        </a>
        <div class="dropdown-menu mega-menu">
          <div class="dropdown-column">
            <div class="dropdown-item">
              <i data-feather="arrow-right-circle"></i>
              <div>
                <strong>N·∫°p ti·ªÅn v√†o t√†i kho·∫£n</strong>
                <span>N·∫°p ti·ªÅn v√†o t√†i kho·∫£n giao d·ªãch ch·ª©ng kho√°n</span>
              </div>
            </div>
            <div class="dropdown-item">
              <i data-feather="refresh-cw"></i>
              <div>
                <strong>Chuy·ªÉn ti·ªÅn n·ªôi b·ªô</strong>
                <span>Chuy·ªÉn ti·ªÅn gi·ªØa c√°c t√†i kho·∫£n t·∫°i SSI</span>
              </div>
            </div>
            <div class="dropdown-item">
              <i data-feather="corner-down-right"></i>
              <div>
                <strong>·ª®ng tr∆∞·ªõc ti·ªÅn b√°n</strong>
                <span>·ª®ng tr∆∞·ªõc ƒë·ªÉ s·ª≠ d·ª•ng d√≤ng ti·ªÅn ƒë·∫ßu t∆∞</span>
              </div>
            </div>
            <div class="dropdown-item">
              <i data-feather="bank"></i>
              <div>
                <strong>Chuy·ªÉn ti·ªÅn ra ng√¢n h√†ng</strong>
                <span>Chuy·ªÉn t·ª´ t√†i kho·∫£n ch·ª©ng kho√°n ra ng√¢n h√†ng</span>
              </div>
            </div>
          </div>
          <div class="dropdown-column">
            <div class="dropdown-item">
              <i data-feather="arrow-left-right"></i>
              <div>
                <strong>N·ªôp/R√∫t k√Ω qu·ªπ ph√°i sinh</strong>
                <span>N·ªôp/r√∫t k√Ω qu·ªπ VSDC cho giao d·ªãch ph√°i sinh</span>
              </div>
            </div>
            <div class="dropdown-item">
              <i data-feather="download"></i>
              <div style="display: flex; align-items: center; gap: 6px;">
                <strong>R√∫t ti·ªÅn b√°n ch·ªù v·ªÅ TK k√Ω qu·ªπ</strong>
                <span class="tag-new">M·ªöI</span>
              </div>
              <span>Theo d√µi, thi·∫øt l·∫≠p l·ªánh r√∫t ti·ªÅn ch·ªù</span>
            </div>
            <div class="dropdown-item">
              <i data-feather="file-text"></i>
              <div>
                <strong>Sao k√™ ti·ªÅn</strong>
                <span>Theo d√µi bi·∫øn ƒë·ªông d√≤ng ti·ªÅn</span>
              </div>
            </div>
          </div>
        </div>
      </li>
    </ul>
  </div>
  <div style="display: flex; align-items: center; gap: 12px; margin: 10px 0;">
    <!-- üîç √î t√¨m ki·∫øm CK -->
    <div style="position: relative;">
      <input type="text" id="stockSearch" placeholder="T√¨m ki·∫øm CK"
        style="padding: 6px 30px 6px 30px; border-radius: 6px; border: 1px solid #ccc;">
      <i data-feather="search"
        style="position: absolute; left: 8px; top: 50%; transform: translateY(-50%); color: #aaa;"></i>
    </div>

    <!-- Nh√≥m n√∫t s√†n -->
    <div class="btn-group" role="group" aria-label="Ch·ªçn s√†n/ch·ªâ s·ªë">
      <button onclick="handleExchangeClick('HOSE')" class="btn btn-primary">HOSE</button>
      <button onclick="handleExchangeClick('HNX')" class="btn btn-primary">HNX</button>
      <button onclick="handleExchangeClick('UPCOM')" class="btn btn-primary">UPCOM</button>
      <button onclick="handleExchangeClick('VN30')" class="btn btn-success">VN30</button>
      <button onclick="handleExchangeClick('VN100')" class="btn btn-success">VN100</button>
      <button onclick="handleExchangeClick('HNX30')" class="btn btn-success">HNX30</button>
    </div>
  </div>


  <table id="data-table">
    <thead>
      <tr>
        <th rowspan="2">CK</th>
        <th rowspan="2">Tr·∫ßn</th>
        <th rowspan="2">S√†n</th>
        <th rowspan="2">TC</th>
        <th colspan="6">B√™n mua</th>
        <th colspan="4">Kh·ªõp l·ªánh</th>
        <th colspan="6">B√™n b√°n</th>
        <th rowspan="2">T·ªïng KL</th>
        <th rowspan="2">Cao</th>
        <th rowspan="2">Th·∫•p</th>
      </tr>
      <tr>
        <th>Gi√° 3</th>
        <th>KL 3</th>
        <th>Gi√° 2</th>
        <th>KL 2</th>
        <th>Gi√° 1</th>
        <th>KL 1</th>
        <th>Gi√°</th>
        <th>KL</th>
        <th>+/-</th>
        <th>+/- (%)</th>
        <th>Gi√° 1</th>
        <th>KL 1</th>
        <th>Gi√° 2</th>
        <th>KL 2</th>
        <th>Gi√° 3</th>
        <th>KL 3</th>
      </tr>
    </thead>
    <tbody id="data-body">
    </tbody>
  </table>

  <script>
    var socket = io();
    const dataMap = {};
    // üëâ G·∫Øn s·ª± ki·ªán sau khi DOM ƒë√£ c√≥ b·∫£ng
    document.addEventListener("DOMContentLoaded", function () {
      document.getElementById("data-body").addEventListener("click", function (e) {
        const cell = e.target.closest("td");
        if (!cell) return;

        // Ch·ªâ x·ª≠ l√Ω n·∫øu √¥ c√≥ class symbol-cell
        if (cell.classList.contains("symbol-cell")) {
          const symbol = cell.dataset.symbol;
          const item = dataMap[symbol];
          if (item) {
            showStockModal(item);
          }
        }
      });
    });
    socket.on('connect', function () {
      console.log('Connected to server');
    });

    socket.on('server_data', function (data) {
      try {
        const parsedData = JSON.parse(data);
        const symbol = parsedData.Symbol;
        if (!symbol) return;

        dataMap[symbol] = parsedData;
        updateTable();

      } catch (e) {
        console.error('Invalid JSON:', data);
      }
    });

    function updateTable() {
      const tbody = document.getElementById('data-body');
      tbody.innerHTML = ''; // Clear previous

      // S·∫Øp x·∫øp theo A-Z
      const sortedData = Object.values(dataMap).sort((a, b) => a.Symbol.localeCompare(b.Symbol));

      sortedData.forEach(item => {
        const row = document.createElement('tr');

        const fields = [
          "Symbol", "Ceiling", "Floor", "RefPrice",
          "BidPrice3", "BidVol3",
          "BidPrice2", "BidVol2",
          "BidPrice1", "BidVol1",
          "LastPrice", "LastVol", "Change", "RatioChange",
          "AskPrice1", "AskVol1",
          "AskPrice2", "AskVol2",
          "AskPrice3", "AskVol3",
          "TotalVol", "High", "Low"
        ];

        fields.forEach(field => {
          const cell = document.createElement('td');
          const value = item[field];
          if (field === "Symbol") {

            cell.classList.add("symbol-cell"); // üëà ƒê√°nh d·∫•u class
            cell.dataset.symbol = item.Symbol; // üëà L∆∞u symbol ƒë·ªÉ l·∫•y khi click
          }
          if (typeof value === 'number') {
            if (field.includes("Price") || field === "Ceiling" || field === "Floor" || field === "RefPrice" || field === "LastPrice" || field === "High" || field === "Low" || field.includes("AskPrice") || field.includes("BidPrice")) {
              // Gi√° chia 1000
              cell.textContent = (value / 1000).toFixed(2);
            } else if (field.includes("Vol") || field === "TotalVol" || field === "LastVol") {
              // Kh·ªëi l∆∞·ª£ng gi·ªØ nguy√™n, format s·ªë c√≥ d·∫•u ph·∫©y
              cell.textContent = value.toLocaleString("en-US");
            } else if (field === "Change" || field === "RatioChange") {
              // TƒÉng/gi·∫£m tuy·ªát ƒë·ªëi v√† ph·∫ßn trƒÉm
              const display = (value > 0 ? '+' : '') + value.toFixed(2);
              cell.textContent = field === "RatioChange" ? display + '%' : display;
              cell.style.color = value > 0 ? 'limegreen' : value < 0 ? 'red' : '#333';
            } else {
              cell.textContent = value;
            }
          } else {
            cell.textContent = value || "";
          }

          row.appendChild(cell);
        });

        tbody.appendChild(row);
      });
    }

    function handleExchangeClick(exchangeName) {
      // üßπ Xo√° d·ªØ li·ªáu c≈©
      for (const key in dataMap) {
        delete dataMap[key];
      }
      document.getElementById('data-body').innerHTML = '';

      socket.emit('button_click', { exchange: exchangeName });
      console.log("üì§ ƒê√£ g·ª≠i y√™u c·∫ßu button_click:", exchangeName);
    }

    socket.on('disconnect', function () {
      console.log('Disconnected from server');
    });
  </script>
  <div id="loginModal" class="modal-overlay"
    style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 9999;">
    <div class="modal-content"
      style="background: white; border-radius: 10px; width: 500px; height: 580px; position: relative; overflow: hidden;">
      <button class="close-btn" onclick="closeLoginModal()"
        style="position: absolute; top: 10px; right: 15px; font-size: 22px; background: none; border: none; cursor: pointer; z-index: 10;">√ó</button>
      <iframe src="/login" style="width: 100%; height: 100%; border: none;"></iframe>
    </div>
  </div>

  <!-- üîç Modal hi·ªÉn th·ªã th√¥ng tin chi ti·∫øt CK -->
  <div id="stockModal" class="modal-overlay-detail-form">
    <div class="modal-content">
      <button class="close-btn" onclick="closeStockModal()">√ó</button>
      <iframe src="/detailform" style="width: 100%; height: 100%; border: none;"></iframe>
    </div>
  </div>

  <script>
    function showStockModal(item) {
      const modal = document.getElementById('stockModal');
      const iframe = modal.querySelector('iframe');

      modal.style.display = 'flex';

      // B·∫Øt s·ª± ki·ªán load l·∫ßn ƒë·∫ßu
      iframe.onload = function () {
        iframe.contentWindow.postMessage({
          type: 'update_stock_detail',
          payload: item
        }, '*');
      };

      // N·∫øu iframe ƒë√£ load t·ª´ tr∆∞·ªõc (kh√¥ng thay src n·ªØa), g·ª≠i lu√¥n
      if (iframe.contentWindow && iframe.src.includes('/detailform')) {
        // Delay nh·∫π ƒë·ªÉ ƒë·∫£m b·∫£o iframe ƒë√£ ready
        setTimeout(() => {
          iframe.contentWindow.postMessage({
            type: 'update_stock_detail',
            payload: item
          }, '*');
        }, 100);
      }
    }



    function closeStockModal() {
      document.getElementById('stockModal').style.display = 'none';
    }
  </script>

  <div id="registerModal" class="modal-overlay"
    style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 9999;">
    <div class="modal-content"
      style="background: white; border-radius: 10px; width: 500px; height: 580px; position: relative; overflow: hidden;">
      <button class="close-btn" onclick="closeRegisterModal()"
        style="position: absolute; top: 10px; right: 15px; font-size: 22px; background: none; border: none; cursor: pointer; z-index: 10;">√ó</button>
      <iframe src="/register" style="width: 100%; height: 100%; border: none;"></iframe>
    </div>
  </div>
  <script>

    function updateClock() {
      const now = new Date();
      const h = String(now.getHours()).padStart(2, '0');
      const m = String(now.getMinutes()).padStart(2, '0');
      const s = String(now.getSeconds()).padStart(2, '0');
      document.getElementById("clock").textContent = `${h}:${m}:${s}`;
    }
    setInterval(updateClock, 1000);
    updateClock();

    document.addEventListener('DOMContentLoaded', () => {
      const langBtn = document.querySelector('.lang-btn');
      const langMenu = document.querySelector('.lang-menu');

      langBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        langMenu.style.display = langMenu.style.display === 'block' ? 'none' : 'block';
      });

      document.addEventListener('click', () => {
        langMenu.style.display = 'none';
      });
    });
  </script>
  <script>
    feather.replace();
  </script>
  <script>
    function openLoginModal() {
      document.getElementById('loginModal').style.display = 'flex';
    }

    function closeLoginModal() {
      document.getElementById('loginModal').style.display = 'none';
    }

    document.getElementById('loginForm').addEventListener('submit', function (e) {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      socket.emit('login', { username, password });
    });

    socket.on('login_success', function (data) {
      closeLoginModal();

      // Hi·ªÉn th·ªã ph·∫ßn ch√†o v√† ƒëƒÉng xu·∫•t
      document.getElementById('usernameDisplay').innerText = data.username;
      document.getElementById('userInfo').style.display = 'inline-block';

      // ·∫®n c√°c n√∫t cho kh√°ch
      document.getElementById('loginBtn').style.display = 'none';
      document.getElementById('openAccountBtn').style.display = 'none';
    });

    socket.on('login_failed', function (data) {
      alert(data.message);
    });
  </script>
  <script>
    function openRegisterModal() {
      document.getElementById('registerModal').style.display = 'flex';
    }
    function closeRegisterModal() {
      document.getElementById('registerModal').style.display = 'none';
    }
  </script>
  <script>
    function logout() {
      // G·ª≠i y√™u c·∫ßu ƒëƒÉng xu·∫•t n·∫øu c·∫ßn (socket.emit('logout'))
      // ·∫®n th√¥ng tin ng∆∞·ªùi d√πng
      document.getElementById('userInfo').style.display = 'none';

      // Hi·ªán l·∫°i c√°c n√∫t cho kh√°ch
      document.getElementById('loginBtn').style.display = 'inline-block';
      document.getElementById('openAccountBtn').style.display = 'inline-block';

      // X√≥a t√™n ng∆∞·ªùi d√πng hi·ªÉn th·ªã
      document.getElementById('usernameDisplay').innerText = '';
    }
  </script>
  <script>
    window.addEventListener('message', function (event) {
      if (event.data && event.data.type === 'register_success') {
        const username = event.data.username;

        // ƒê√≥ng modal ƒëƒÉng k√Ω
        closeRegisterModal();

        // C·∫≠p nh·∫≠t UI ch√≠nh
        document.getElementById('usernameDisplay').innerText = username;
        document.getElementById('userInfo').style.display = 'inline-block';
        document.getElementById('loginBtn').style.display = 'none';
        document.getElementById('openAccountBtn').style.display = 'none';
      }

      document.getElementById('stockSearch').addEventListener('input', function () {
        const keyword = this.value.trim().toUpperCase();
        const rows = document.querySelectorAll('#data-body tr');

        rows.forEach(row => {
          const symbolCell = row.querySelector('td');
          const symbol = symbolCell?.textContent.toUpperCase() || '';
          row.style.display = symbol.includes(keyword) ? '' : 'none';
        });
      });
    });
    window.onload = function () {
      handleExchangeClick('VN30');
    };
  </script>
</body>

</html>