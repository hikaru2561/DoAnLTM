<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>WebSocket Table</title>
    <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/dashboard.css') }}"
    />
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
      table {
        border-collapse: collapse;
        width: 100%;
      }

      th,
      td {
        border: 1px solid #ccc;
        padding: 4px 8px;
        text-align: center;
      }

      th {
        background-color: #f0f0f0;
      }
    </style>
  </head>

  <body>
    <div class="header-bar">
      <div class="logo-section">
        <div class="logo-icon">QQT</div>
      </div>

      <div class="right-section">
        <!-- ƒê·ªìng h·ªì -->
        <span class="clock" id="clock">--:--:--</span>

        <div class="icon-wrapper" title="Th√¥ng b√°o">
          <i data-feather="bell"></i>
        </div>

        <!-- Bi·ªÉu t∆∞·ª£ng ƒë·ªïi n·ªÅn (m·∫∑t tr·ªùi) -->
        <div class="icon-wrapper" title="M√†u n·ªÅn">
          <i data-feather="sun"></i>
        </div>

        <!-- Ng√¥n ng·ªØ -->
        <div class="lang-dropdown">
          <button class="icon-wrapper lang-btn" title="Ng√¥n ng·ªØ">
            <img
              src="https://flagcdn.com/h40/vn.png"
              class="flag-icon-round"
              alt="VN"
            />
          </button>
          <div class="lang-menu">
            <div class="lang-item">
              <img src="https://flagcdn.com/h40/us.png" alt="EN" /> English
            </div>
            <!-- <div class="lang-item"><img src="https://flagcdn.com/h40/vn.png" alt="VN"> Ti·∫øng Vi·ªát</div> -->
            <div class="lang-item">
              <img src="https://flagcdn.com/h40/cn.png" alt="CN" /> ‰∏≠Êñá
              (Chinese)
            </div>
          </div>
        </div>

        <!-- Hi·ªÉn th·ªã sau khi ƒëƒÉng nh·∫≠p -->
        <div id="userInfo" style="display: none">
          <span>Xin ch√†o, <strong id="usernameDisplay"></strong></span>
          <button onclick="logout()">ƒêƒÉng xu·∫•t</button>
        </div>

        <button id="loginBtn" onclick="window.location.href='/login'">
          ƒêƒÉng nh·∫≠p
        </button>
        <button id="openAccountBtn" onclick="window.location.href='/register'">
          M·ªü t√†i kho·∫£n
        </button>
      </div>
    </div>
    <!-- üî∫ Submenu theo y√™u c·∫ßu -->
    <div class="submenu">
      <ul class="submenu-list">
        <!-- B·∫£ng gi√° -->
        <li class="nav-item">
          <a href="#" class="nav-link">B·∫£ng gi√°</a>
        </li>

        <!-- Giao d·ªãch c∆° s·ªü -->
        <li class="nav-item dropdown">
          <a href="#" class="nav-link">
            Giao d·ªãch c∆° s·ªü
            <i class="arrow-down" data-feather="chevron-down"></i>
          </a>
          <div class="dropdown-menu mega-menu">
            <div class="dropdown-column">
              <div class="dropdown-item">
                <a
                  href="/order/place"
                  class="dropdown-item"
                  style="display: flex; align-items: center; gap: 10px"
                >
                  <div>
                    <strong>ƒê·∫∑t l·ªánh</strong>
                    <span>ƒê·∫∑t l·ªánh mua b√°n ch·ª©ng kho√°n</span>
                  </div>
                </a>
              </div>
              <div class="dropdown-item">
                <a
                  href="/order/history/page"
                  class="dropdown-item"
                  style="display: flex; align-items: center; gap: 10px"
                >
                  <div>
                    <strong>L·ªãch s·ª≠ l·ªánh</strong>
                    <span>Xem danh s√°ch l·ªánh ƒë√£ ƒë·∫∑t</span>
                  </div>
                </a>
              </div>
              <div class="dropdown-item">
                <a href="/order/book/page" class="dropdown-item">
                  <i data-feather="shuffle"></i>
                  <div>
                    <strong>S·ªï l·ªánh</strong>
                    <span>Danh s√°ch l·ªánh ƒë√£ ƒë·∫∑t</span>
                  </div>
                </a>
              </div>
            </div>
          </div>
        </li>

        <!-- Qu·∫£n l√Ω t√†i s·∫£n -->
        <li class="nav-item dropdown">
          <a href="#" class="nav-link">
            Qu·∫£n l√Ω t√†i s·∫£n
            <i class="arrow-down" data-feather="chevron-down"></i>
          </a>
          <div class="dropdown-menu mega-menu one-column">
            <div class="dropdown-column">
              <div class="dropdown-item">
                <a
                  href="/portfolio/page"
                  class="dropdown-item"
                  style="display: flex; align-items: center; gap: 10px"
                >
                  <div>
                    <strong>T·∫£i s·∫£n v√† Hi·ªáu xu·∫•t</strong>
                    <span>aaa</span>
                  </div>
                </a>
              </div>
              <div class="dropdown-item">
                <i data-feather="check-circle"></i>
                <div>
                  <strong>L√£i/l·ªó theo giao d·ªãch</strong>
                  <span class="desc"
                    >Theo d√µi l·ªãch s·ª≠ l√£i/l·ªó ƒë√£ th·ª±c hi·ªán theo t·ª´ng m√£ c·ªï
                    phi·∫øu</span
                  >
                </div>
              </div>
            </div>
          </div>
        </li>

        <!-- Giao d·ªãch ti·ªÅn -->
        <li class="nav-item dropdown">
          <a href="#" class="nav-link">
            Giao d·ªãch ti·ªÅn
            <i class="arrow-down" data-feather="chevron-down"></i>
          </a>
          <div class="dropdown-menu mega-menu">
            <div class="dropdown-item">
              <a
                href="/wallet/deposit"
                class="dropdown-item"
                style="display: flex; align-items: center; gap: 10px"
              >
                <i data-feather="arrow-right-circle"></i>
                <div>
                  <strong>N·∫°p ti·ªÅn</strong>
                  <span>N·∫°p ti·ªÅn v√†o t√†i kho·∫£n giao d·ªãch ch·ª©ng kho√°n</span>
                </div>
              </a>
            </div>
            <div class="dropdown-item">
              <a
                href="/wallet/withdraw"
                class="dropdown-item"
                style="display: flex; align-items: center; gap: 10px"
              >
                <div>
                  <strong>R√∫t ti·ªÅn</strong>
                  <span>Chuy·ªÉn t·ª´ t√†i kho·∫£n ch·ª©ng kho√°n ra ng√¢n h√†ng</span>
                </div>
              </a>
            </div>
            <div class="dropdown-item">
              <a
                href="/wallet/history/page"
                class="dropdown-item"
                style="display: flex; align-items: center; gap: 10px"
              >
                <div>
                  <strong>L·ªãch s·ª≠ giao d·ªãch</strong>
                  <span>Danh s√°ch l·ªãch s·ª≠ giao d·ªãch</span>
                </div>
              </a>
            </div>
          </div>
        </li>
      </ul>
    </div>

    <div style="display: flex; align-items: center; gap: 12px; margin: 10px 0">
      <!-- üîç √î t√¨m ki·∫øm CK -->
      <div style="position: relative">
        <input
          type="text"
          id="stockSearch"
          placeholder="T√¨m ki·∫øm CK"
          style="
            padding: 6px 30px 6px 30px;
            border-radius: 6px;
            border: 1px solid #ccc;
          "
        />
        <i
          data-feather="search"
          style="
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            color: #aaa;
          "
        ></i>
      </div>

      <!-- Nh√≥m n√∫t s√†n -->
      <div class="btn-group" role="group" aria-label="Ch·ªçn s√†n/ch·ªâ s·ªë">
        <button onclick="handleExchangeClick('HOSE')" class="btn btn-primary">
          HOSE
        </button>
        <button onclick="handleExchangeClick('HNX')" class="btn btn-primary">
          HNX
        </button>
        <button onclick="handleExchangeClick('UPCOM')" class="btn btn-primary">
          UPCOM
        </button>
        <button onclick="handleExchangeClick('VN30')" class="btn btn-success">
          VN30
        </button>
        <button onclick="handleExchangeClick('VN100')" class="btn btn-success">
          VN100
        </button>
        <button onclick="handleExchangeClick('HNX30')" class="btn btn-success">
          HNX30
        </button>
      </div>
    </div>

    <table id="data-table">
      <thead>
        <tr>
          <th rowspan="2">CK</th>
          <th rowspan="2">Tr·∫ßn</th>
          <th rowspan="2">S√†n</th>
          <th rowspan="2">TC</th>
          <th colspan="6">B√™n mua</th>
          <th colspan="4">Kh·ªõp l·ªánh</th>
          <th colspan="6">B√™n b√°n</th>
          <th rowspan="2">T·ªïng KL</th>
          <th rowspan="2">Cao</th>
          <th rowspan="2">Th·∫•p</th>
        </tr>
        <tr>
          <th>Gi√° 3</th>
          <th>KL 3</th>
          <th>Gi√° 2</th>
          <th>KL 2</th>
          <th>Gi√° 1</th>
          <th>KL 1</th>
          <th>Gi√°</th>
          <th>KL</th>
          <th>+/-</th>
          <th>+/- (%)</th>
          <th>Gi√° 1</th>
          <th>KL 1</th>
          <th>Gi√° 2</th>
          <th>KL 2</th>
          <th>Gi√° 3</th>
          <th>KL 3</th>
        </tr>
      </thead>
      <tbody id="data-body"></tbody>
    </table>

    <script>
      var socket = io();
      const dataMap = {};

      socket.on("connect", function () {
        console.log("Connected to server");
      });

      socket.on("server_data", function (data) {
        try {
          const parsedData = JSON.parse(data);
          const symbol = parsedData.Symbol;
          if (!symbol) return;

          dataMap[symbol] = parsedData;
          updateTable();
        } catch (e) {
          console.error("Invalid JSON:", data);
        }
      });

      function updateTable() {
        const tbody = document.getElementById("data-body");
        tbody.innerHTML = ""; // Clear previous

        // S·∫Øp x·∫øp theo A-Z
        const sortedData = Object.values(dataMap).sort((a, b) =>
          a.Symbol.localeCompare(b.Symbol)
        );

        sortedData.forEach((item) => {
          const row = document.createElement("tr");

          const fields = [
            "Symbol",
            "Ceiling",
            "Floor",
            "RefPrice",
            "BidPrice3",
            "BidVol3",
            "BidPrice2",
            "BidVol2",
            "BidPrice1",
            "BidVol1",
            "LastPrice",
            "LastVol",
            "Change",
            "RatioChange",
            "AskPrice1",
            "AskVol1",
            "AskPrice2",
            "AskVol2",
            "AskPrice3",
            "AskVol3",
            "TotalVol",
            "High",
            "Low",
          ];

          fields.forEach((field) => {
            const cell = document.createElement("td");
            const value = item[field];

            if (typeof value === "number") {
              if (
                field.includes("Price") ||
                field === "Ceiling" ||
                field === "Floor" ||
                field === "RefPrice" ||
                field === "LastPrice" ||
                field === "High" ||
                field === "Low" ||
                field.includes("AskPrice") ||
                field.includes("BidPrice")
              ) {
                // Gi√° chia 1000
                cell.textContent = (value / 1000).toFixed(2);
              } else if (
                field.includes("Vol") ||
                field === "TotalVol" ||
                field === "LastVol"
              ) {
                // Kh·ªëi l∆∞·ª£ng gi·ªØ nguy√™n, format s·ªë c√≥ d·∫•u ph·∫©y
                cell.textContent = value.toLocaleString("en-US");
              } else if (field === "Change" || field === "RatioChange") {
                // TƒÉng/gi·∫£m tuy·ªát ƒë·ªëi v√† ph·∫ßn trƒÉm
                const display = (value > 0 ? "+" : "") + value.toFixed(2);
                cell.textContent =
                  field === "RatioChange" ? display + "%" : display;
                cell.style.color =
                  value > 0 ? "limegreen" : value < 0 ? "red" : "#333";
              } else {
                cell.textContent = value;
              }
            } else {
              cell.textContent = value || "";
            }

            row.appendChild(cell);
          });

          tbody.appendChild(row);
        });
      }

      function handleExchangeClick(exchangeName) {
        for (const key in dataMap) {
          delete dataMap[key];
        }
        document.getElementById("data-body").innerHTML = "";

        socket.emit("button_click", { exchange: exchangeName });
        console.log("üì§ ƒê√£ g·ª≠i y√™u c·∫ßu button_click:", exchangeName);
      }

      socket.on("disconnect", function () {
        console.log("Disconnected from server");
      });

      function updateClock() {
        const now = new Date();
        const h = String(now.getHours()).padStart(2, "0");
        const m = String(now.getMinutes()).padStart(2, "0");
        const s = String(now.getSeconds()).padStart(2, "0");
        document.getElementById("clock").textContent = `${h}:${m}:${s}`;
      }
      setInterval(updateClock, 1000);
      updateClock();
      window.onload = function () {
        handleExchangeClick("VN30");
      };
      feather.replace();
      const searchInput = document.getElementById("stockSearch");
      if (searchInput) {
        searchInput.addEventListener("input", function () {
          const keyword = this.value.trim().toUpperCase();
          const rows = document.querySelectorAll("#data-body tr");

          rows.forEach((row) => {
            const symbolCell = row.querySelector("td");
            const symbol = symbolCell?.textContent.toUpperCase() || "";
            row.style.display = symbol.includes(keyword) ? "" : "none";
          });
        });
      }
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Ki·ªÉm tra xem user ƒë√£ ƒëƒÉng nh·∫≠p ch∆∞a qua session
        fetch("/api/session_info", {
          method: "GET",
          credentials: "include", // üîê B·∫Øt bu·ªôc ƒë·ªÉ g·ª≠i cookie session
        })
          .then((res) => {
            if (!res.ok) throw new Error("Ch∆∞a ƒëƒÉng nh·∫≠p");
            return res.json();
          })
          .then((data) => {
            // ‚úÖ ƒê√£ ƒëƒÉng nh·∫≠p
            document.getElementById("userInfo").style.display = "inline-block";
            document.getElementById("usernameDisplay").innerText =
              data.username;
            document.getElementById("loginBtn").style.display = "none";
            document.getElementById("openAccountBtn").style.display = "none";
          })
          .catch((err) => {
            console.warn("Kh√¥ng x√°c th·ª±c ƒë∆∞·ª£c phi√™n ƒëƒÉng nh·∫≠p:", err);
            // ‚ùå Ch∆∞a ƒëƒÉng nh·∫≠p ‚Üí ·∫©n th√¥ng tin, hi·ªán n√∫t login
            document.getElementById("userInfo").style.display = "none";
            document.getElementById("loginBtn").style.display = "inline-block";
            document.getElementById("openAccountBtn").style.display =
              "inline-block";
          });

        // üëâ X·ª≠ l√Ω n√∫t ƒëƒÉng xu·∫•t
        window.logout = function () {
          fetch("/api/logout", {
            method: "POST",
            credentials: "include",
          }).finally(() => {
            window.location.href = "/login";
          });
        };
      });
      async function fetchWithAuth(url, options = {}) {
        try {
          const response = await fetch(url, options);
          if (response.status === 401) {
            alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p. Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c.");
            // Optionally redirect:
            window.location.href = "/login"; // ƒë·ªïi URL theo h·ªá th·ªëng c·ªßa b·∫°n
            return;
          }

          const data = await response.json();
          return data;
        } catch (error) {
          console.error("L·ªói khi g·ª≠i y√™u c·∫ßu:", error);
          alert("ƒê√£ x·∫£y ra l·ªói. Vui l√≤ng th·ª≠ l·∫°i.");
        }
      }
    </script>
  </body>
</html>
